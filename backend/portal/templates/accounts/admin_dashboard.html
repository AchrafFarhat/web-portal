
{% extends 'accounts/main.html' %}

{% block content %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>


  <style>
    .sidebar {
    min-height: calc(100vh - 60px); /* Adjust the height to account for the navbar */
    width: 250px;
    background-color: #212529;
    position: fixed;
    top: 68px; /* Add a top margin equal to the navbar height */
    left: 0;
    z-index: 4;
    padding-top: 1rem;
    }

    .sidebar .nav-link {
      color: rgba(255, 255, 255, 0.75);
      font-weight: bold;
      padding: 0.75rem 1rem;
    }

    .sidebar .nav-link:hover,
    .sidebar .nav-link:focus {
      color: white;
      background-color: rgba(255, 255, 255, 0.1);
    }

    .content-container {
    margin-left: 250px;
    margin-top: 60px; /* Add a top margin equal to the navbar height */
    padding: 2rem;
    }
  </style>




  <div class="sidebar">
    <ul class="nav flex-column">
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="loadUsers()">Users</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="loadGroups()">Groups</a>
      </li>    
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="loadStreamlitApp()">Reporting</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="loadForecastingApp()">Forecasting</a>
      </li>
    </ul>
  </div>

  <div class="container" style="padding-left: 137px; padding-right: 30px; margin-top: 0px;">
    <div id="users-welcome" style="display:none;">
      <div class="row">
        <div class="col text-center">
          
          <img src="https://managers.tn/wp-content/uploads/2020/03/image001.png" alt="Your image description" style="width: 115%; height: 600;">
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12 data-container"></div>
    </div>
    <iframe id="streamlit-iframe" src="http://localhost:8501" width="115%" height="1500" frameborder="1" style="display:none;"></iframe>
    <iframe id="streamlit-iframe1" src="http://localhost:8502" width="115%" height="1500" frameborder="1" style="display:none;"></iframe>
  </div>


    <!-- Load Plotly.js and Bootstrap from a CDN -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  
    <script>

document.getElementById('users-welcome').style.display = 'block';




function loadUsers() {
  // Hide the Streamlit app iframe
  document.getElementById('streamlit-iframe').style.display = 'none';
  // Hide the users-welcome div
  hideUsersWelcome();
  fetch('{% url "get_users" %}')
    .then(response => response.json())
    .then(users => {
      let usersData = JSON.parse(users);
      let usersHtml = `
        <div class="d-flex justify-content-between align-items-center">
          <h3>Users Informations</h3>
          <a href="{% url 'add_user' %}" class="btn btn-primary">Add User</a>
        </div>
        <table class="table table-hover table-bordered">
          <thead class="table-primary">
            <tr>
              <th>ID</th>
              <th>Email</th>
              <th>Username</th>
              <th>group</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>`;
      usersData.forEach(user => {
        usersHtml += `
          <tr>
            <td>${user.pk}</td>
            <td>${user.email}</td>
            <td>${user.username}</td>
            <td>${user.group_names}</td>
            <td>
              <button onclick="editUser(${user.pk})" class="btn btn-warning">Edit</button>
              <button onclick="deleteUser(${user.pk})" class="btn btn-danger">Delete</button>
            </td>
          </tr>`;
      });
      usersHtml += `
          </tbody>
        </table>`;
      document.querySelector('.data-container').innerHTML = usersHtml;
    });
}




function editUser(userId) {
    window.location.href = `{% url 'edit_user' 0 %}`.replace('0', userId);
}



      function hideUsersWelcome() {
      // Hide the users-welcome div
      document.getElementById('users-welcome').style.display = 'none';
      }



      function deleteUser(userId) {
        fetch(`{% url 'delete_user' 0 %}`.replace('0', userId), {
          method: 'DELETE',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          },
        })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              loadUsers(); // Reload the users list after deleting a user
            } else {
              alert('Error deleting user');
            }
          });
      }

      // Helper function to get a cookie value by name
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }




      function loadGroups() {
  // Hide the Streamlit app iframe
  document.getElementById('streamlit-iframe').style.display = 'none';
  hideUsersWelcome();
  fetch('{% url "get_groups" %}')
    .then(response => response.json())
    .then(groups => {
      let groupsData = JSON.parse(groups);
      let groupsHtml = `
        <h3>Groups</h3>
        <table class="table table-hover table-bordered">
          <thead class="table-primary">
            <tr>
              <th>ID</th>
              <th>Name</th>
            </tr>
          </thead>
          <tbody>`;
      groupsData.forEach(group => {
        groupsHtml += `
          <tr>
            <td>${group.pk}</td>
            <td>${group.fields.name}</td>
          </tr>`;
      });
      groupsHtml += `
          </tbody>
        </table>`;
      document.querySelector('.data-container').innerHTML = groupsHtml;
    });
}




      function loadStreamlitApp() {
        // Hide the user information
        document.querySelector('.data-container').innerHTML = '';
        hideUsersWelcome();
        const iframe = document.getElementById('streamlit-iframe');
        iframe.style.display = 'block';
      }


      function loadForecastingApp() {
        // Hide the user information
        document.querySelector('.data-container').innerHTML = '';
        hideUsersWelcome();
        const iframe = document.getElementById('streamlit-iframe1');
        iframe.style.display = 'block';
      }









      
    </script>
  
  
{% endblock %}
